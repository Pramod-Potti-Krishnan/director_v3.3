# Director Agent v3.1 Implementation Plan
**Stage 6 - Text Service Integration (Minimal Viable Content Generation)**

---

## ğŸ“‹ Executive Summary

**Objective:** Add Stage 6 (CONTENT_GENERATION) to Director v2.0 with TEXT SERVICE ONLY integration, proving the end-to-end content generation workflow with minimal complexity.

**Baseline:** v2.0 (stable, 5-stage workflow, deck-builder integration working)

**Time Budget:** 2-3 hours maximum

**Success Metric:** User receives deck URL with REAL TEXT CONTENT (not placeholders) after Stage 6

---

## ğŸ¯ Scope Definition

### IN-SCOPE âœ…
1. Copy v2.0 as starting point for v3.1
2. Add CONTENT_GENERATION state to workflow
3. Integrate Text Service client (reuse from v3.0)
4. Sequential slide processing (for each slide â†’ call Text Service)
5. Package results in EnrichedPresentationStrawman format
6. Pass enriched presentation to Layout Architect
7. Return deck URL with real text content
8. Basic error handling (fail gracefully, return v2.0-style deck on error)

### OUT-OF-SCOPE âŒ
1. NO image generation
2. NO chart/analytics generation
3. NO diagram generation
4. NO parallel service orchestration
5. NO Content Orchestrator module
6. NO complex retry logic (simple fail-once is acceptable)
7. NO new coordination/orchestration classes

---

## ğŸ“ File Structure

```
v3.1/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ settings.py                    # ADD: TEXT_SERVICE_URL, TEXT_SERVICE_TIMEOUT
â”‚   â”œâ”€â”€ prompts/modular/              # COPY from v2.0 (no changes)
â”‚   â””â”€â”€ deck_builder/                 # COPY from v2.0 (no changes)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â”œâ”€â”€ director.py               # MODIFY: Add Stage 6 logic
â”‚   â”‚   â””â”€â”€ intent_router.py          # COPY from v2.0
â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â””â”€â”€ websocket.py              # MODIFY: Add CONTENT_GENERATION state handling
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ agents.py                 # MODIFY: Add EnrichedPresentationStrawman
â”‚   â”‚   â””â”€â”€ content.py                # NEW: GeneratedText, EnrichedSlide models
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ text_service_client.py    # NEW: Copy RealTextClient from v3.0
â”‚   â”‚   â””â”€â”€ [all other v2.0 utils]    # COPY unchanged
â”‚   â”œâ”€â”€ workflows/
â”‚   â”‚   â””â”€â”€ state_machine.py          # MODIFY: Add CONTENT_GENERATION state
â”‚   â””â”€â”€ storage/                      # COPY from v2.0
â”œâ”€â”€ .env.example                      # MODIFY: Add TEXT_SERVICE_URL
â””â”€â”€ main.py                          # COPY from v2.0
```

---

## âœ… Success Criteria

### Must Pass ALL Before Declaring Stable:

1. âœ… Text Service client successfully calls production API
2. âœ… Stage 6 processes all slides sequentially (no parallel issues)
3. âœ… Generated text is HTML format and non-empty
4. âœ… EnrichedPresentationStrawman structure correct
5. âœ… Content Transformer injects real text (not placeholders)
6. âœ… Layout Architect receives enriched presentation
7. âœ… Returns deck URL with REAL TEXT CONTENT visible
8. âœ… NO REGRESSIONS in Stages 1-5 functionality
9. âœ… Graceful fallback when Text Service fails
10. âœ… Implementation <200 lines of NEW code (excluding copied v3.0 client)

### Performance Targets:
- Stage 6 completes in <90 seconds for 10-slide deck
- Text Service timeout handled gracefully
- No memory leaks after 50+ requests

---

## ğŸš¨ Abort Triggers

**STOP and revert to v2.0-stable if ANY occur:**

1. Implementation takes >4 hours
2. Claude Code enters debugging loop (>3 iterations on same issue)
3. Any Stage 1-5 regression
4. NEW code >200 lines (excluding copied client)
5. Find yourself creating "orchestrator" or "coordinator" classes
6. Railway deployment fails twice
7. Layout Architect integration breaks
8. Complexity spiraling (adding abstractions, parallel logic, etc.)

---

## ğŸ“ Implementation Checklist

### Pre-Implementation âœ…
- [x] Read this plan thoroughly
- [x] Verify v2.0 is stable and working
- [x] Tag v2.0 as v2.0-stable in git
- [x] Copy v2.0 â†’ v3.1

### Phase 1: Text Service Client (30 min)
- [ ] Create `src/utils/text_service_client.py`
- [ ] Create `src/models/content.py` with models
- [ ] Update `config/settings.py` with TEXT_SERVICE_* settings
- [ ] Update `.env.example`
- [ ] Test Text Service client in isolation

### Phase 2: Workflow Updates (15 min)
- [ ] Update `src/workflows/state_machine.py` with CONTENT_GENERATION state
- [ ] Verify intent router handles Accept_Strawman â†’ CONTENT_GENERATION

### Phase 3: Director Stage 6 Logic (60 min)
- [ ] Add Text Service client initialization in `director.py __init__`
- [ ] Implement CONTENT_GENERATION case in `process()`
- [ ] Add `_generate_slide_text()` helper
- [ ] Add `_send_enriched_to_layout_architect()` helper
- [ ] Add fallback logic for failures

### Phase 4: Content Transformer Update (30 min)
- [ ] Modify `transform_presentation()` to accept enriched_data
- [ ] Update `_map_slide_content()` to use generated text
- [ ] Test transformation with enriched data

### Phase 5: WebSocket Handler Update (20 min)
- [ ] Update `_determine_next_state()` mapping
- [ ] Add pre-generation status message
- [ ] Test state transitions

### Phase 6: Testing & Validation (30 min)
- [ ] Create `test_text_service_integration.py`
- [ ] Test Text Service client standalone
- [ ] Test Stage 6 workflow in isolation
- [ ] Full end-to-end test (Stages 1-6)
- [ ] Regression test Stages 1-5
- [ ] Test error scenarios (timeout, API failure)

### Phase 7: Documentation
- [ ] Create `V3.1_CHANGELOG.md`
- [ ] Update README with Stage 6 info
- [ ] Document Text Service integration

---

## ğŸ”® Post-v3.1 Roadmap

**ONLY proceed after v3.1 is STABLE for 24+ hours:**

- **v3.2:** Add Image Service (one service at a time)
- **v3.3:** Add Chart/Analytics Service
- **v3.4:** Add Diagram Service
- **v3.5:** Consider parallel orchestration (if needed)

---

## ğŸ¯ Key Implementation Principles

1. **KISS:** Keep It Simple, Stupid - no orchestrators, no parallel complexity
2. **Sequential Processing:** One slide at a time is acceptable for v3.1
3. **Direct Calls:** Director â†’ Text Service â†’ Layout Architect (3 hops max)
4. **Fail Gracefully:** Return v2.0-style deck on any error
5. **Reuse v3.0 Assets:** Copy working RealTextClient and models
6. **NO v3.0 Mistakes:** NO orchestration layer, NO parallel processing
7. **Test Early:** Test Text Service client BEFORE integrating
8. **Regression First:** Ensure v2.0 functionality preserved

---

**Implementation Start:** 2025-10-20
**Status:** In Progress
**Current Phase:** Phase 1 - Text Service Client Setup
